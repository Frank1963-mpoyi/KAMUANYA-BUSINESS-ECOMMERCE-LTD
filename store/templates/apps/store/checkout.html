{% extends 'base.html' %}
{% load static %}


{% block content %}


<style>
    .hidden{
    display:none;
    }

      .btn-outline-secondarys{
        background: #DC5B21;
    }

      .btn-outline-secondarys:hover{
         background: #E4DBBF;
    }

</style>

{% include 'apps/store/_includes/banner.html' %}
<!-- Start Cart  -->
<div class="cart-box-main mt-5" style="margin-bottom:350px">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-lg-6 mb-3">

                <div class="checkout-address" id="form-wrapper">
                    <form class="needs-validation" id="form" novalidate>
                        {#% csrf_token %#}
                        <div class="row" id="user-info">
                            <div class="col-md-6 mb-3">
                                <label for="name"> Name </label>
                                <input class="form-control" id="name" placeholder="" required type="text" value="">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email"> Email </label>
                                <input class="form-control" id="email" placeholder="" required type="email" value="">
                            </div>
                        </div>
                        <hr>
                        <div id="shipping-info">
                            <div class="title-left text-center">
                                <h3>Shipping address</h3>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="address"> Address </label>
                                    <input class="form-control" id="address" name="address" placeholder="" type="text" value="">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="city"> City </label>
                                    <input class="form-control" id="city" name="city" placeholder="" type="text" value="">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="state"> State </label>
                                    <input class="form-control" id="state" name="state" placeholder="" type="text" value="">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="zipcode">Zip Code </label>
                                    <input class="form-control" id="zipcode" name="zipcode" placeholder="" type="text" value="">
                                </div>
                            </div>

                            <hr>
                        </div>

                        <input class="btn btn-outline-secondarys " id="form-button" type="submit" value="Continue">
                    </form>
                </div>

                <br>
                <div class="box-element hidden" id="payment-info">
                    <p class="mt-3">Paypal Options</p>
                    <div id="paypal-button-container"></div>
                    {#<button id="make-payment"> Make payment</button>#}
                </div>

            </div>

            <div class="col-sm-6 col-lg-6 mb-3">
                <div class="row">
                    <div class="col-md-12 col-lg-12">
                        <div class="order-box">
                            <div class="title-left mb-3">
                                <h2 class="text-center"> Order Summary </h2>
                            </div>
                            <hr>
                            <div class="d-flex">
                                <h4 class="font-weight-bold">Product</h4>
                                <h4 class="ml-auto font-weight-bold">Price</h4>
                            </div>
                            <hr class="my-1">

                            {% for item in items %}
                            <div class="d-flex">
                                <h5> {{ item.product.title }}</h5>
                                <div class="ml-auto font-weight-bold display-5"> x {{ item.quantity }}&nbsp; &nbsp;
                                    &nbsp; &nbsp;
                                    $ {{ item.product.price }}
                                </div>
                            </div>
                            {% endfor %}
                            <hr>
                            <div class="d-flex gr-total">
                                <h4>Grand Total</h4>
                                <div class="ml-auto h5"> $ <b>{{ order.get_cart_total }} </b></div>
                            </div>
                            <hr>
                        </div>
                    </div>
                    <div class="col-12 float-left"><a class="ml-auto btn btn-dark"
                                                      href="{% url 'store:cart' %}">&#x2190; Back to cart </a></div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=ASF1LGUW19CWWCEzcGfFhw4GqF0omV1pKrpdGi6sR5Ph3i7zyr5yIGrbE52Myqddph9F6w1S6O22TmnW&currency=USD&disable-funding=credit"></script>

<script>
    var total = "{{ order.get_cart_total }}"

    paypal.Buttons({

    style:{
        color: 'blue',
        shape: 'rect',
    },

    // ser up the transaction
    createOrder: function(data, actions){
    return actions.order.create({
        purchase_units: [{
            amount: {
                value: parseFloat(total).toFixed(2)
            }
        }]
    });
    },

    //Finalize the transaction
    onApprove: function(data, actions){
        return actions.order.capture().then(function(details){
            //alert("Transaction complete by " + details.payer.none.give_name + '|');

            submitFormData()
        });
    }

    }).render('#paypal-button-container');
</script>


<!-- End Cart -->
<script type="text/javascript">

    var shipping = "{{ order.shipping}}"
    //var total = "{{ order.get_cart_total }}"

        if (shipping == "False"){
        document.getElementById("shipping-info").innerHTML = ""
    }

     if (user != 'AnonymousUser'){
        document.getElementById('user-info').innerHTML=""
    }

    if (shipping == 'False' && user != 'AnonymousUser'){
        // Hide entire form if user is logged in and shipping is false
        document.getElementById('form-wrapper').classList.add('hidden');

        // Show payment if logged in user wants to buy an item that does not require shipping
        document.getElementById('payment-info').classList.remove('hidden');

    }

    var form = document.getElementById("form")

    //csrftoken = form.getElementsByTagName("input")[0].value

        form.addEventListener("submit", function(e) {
        e.preventDefault()
        console.log(" form submitted ")

        document.getElementById("form-button").classList.add("hidden");
        document.getElementById("payment-info").classList.remove("hidden")
    }  )

    //document.getElementById("make-payment").addEventListener("click", function(e) {
       // submitFormData()
    //})

    function submitFormData(){
        console.log('payment button is clicked')

        // create empty object form and update it later

        var userFormData = {
            "name": null,
            "email": null,
            "total": total
        }

        // create shipping address form

        var shippingInfo = {
            "address": null,
            "city":null,
            "state":null,
            "zipcode":null,
        }

          if (shipping != "False"){

        shippingInfo.address = form.address.value
        shippingInfo.city = form.city.value
        shippingInfo.state = form.state.value
        shippingInfo.zipcode = form.zipcode.value

    }

    if ( user == "AnonymousUser"){

        userFormData.name = form.name.value
        userFormData.email = form.email.value

    }

    //console.log("Shipping Info: ", shippingInfo)
    //console.log("User Info: ", userFormData)


    var url='/process_order/'

    fetch(url,{
        method: 'POST',
        headers: {
        'Content-Type':'application/json',
        'X-CSRFToken':csrftoken,
    },
    body:JSON.stringify({ 'form':userFormData, 'shipping':shippingInfo})

    })
    .then((response) => { return response.json() })
    .then((data) => {
        console.log("success: ", data);

        alert("Transaction completed");

        // add cart to clear the cookie

        cart = {}

        document.cookie = "cart=" + JSON.stringify(cart) + ";domain=;path=/"

        window.location.href = "{% url 'store:home' %}"

    })

}

</script>
{% endblock content %}